#!/bin/sh
#//////////////////////////////////////////////////
#//DESLinux Boot Loader
#//	(C)2014-2022 Dark Embedded Systems.
#//	http://xprj.net/
#//////////////////////////////////////////////////
PREVCNT=65536;

# Supported kernel cmdlines:
#	rootwait=waittime(s)		Time in seconds to wait initialize storage devices.

main(){
	load_cmdline;

	load_boot_drivers;

	echo 'I: Waiting boot device to initialize...'
	sleep ${CMD_rootwait:-0}

	echo "I: Mapping devices to '/dev'..."
	register_dev scan

	return 0;
}

load_cmdline(){
	local IFS=$' ';
	for kv in desl `cat /proc/cmdline` ; do
		IFS=$'=';
		set -- ${kv}
		local K="${1}";
		shift
		local V="${*:--}";
		eval CMD_${K//-/_}=\"${V}\";
	done
	return 0;
}

check_exec(){
	"${1}" --help
	[ "${?}" = '127' ] && {
		echo "${1} is not found." >&3
		exit 21;
	}
	return 0;
}

check_dependencies(){
#	check_exec 'devmm2name'
	return 0;
}

register_dev(){
	# Using devtmpfs or already registered
	[ -e '/dev/null' ] && return 0;
	[ -e '/dev/zero' ] && return 0;

	# 'devManager' method
	/DRoot/DESLBoot/devManager ${1} && return 0;
	devManager ${1} && return 0;

	# 'devmm2name' method (No devtmpfs support or failed)
	check_dependencies;
	devmm2name ${1} && return 0;

	return 1;
}

check_redetect_required(){
	local CNT=0;
	local IFS=$'\r\n';

	for m in `lsmod`; do
		CNT=$((CNT+1));
	done

	[ "${CNT}" = "${PREVCNT}" ] && {
		PREVCNT=${CNT};
		return 0;
	}

	PREVCNT=${CNT};
	return 1;
}

detect_and_load_devices(){
	for m in /sys/bus/*/devices/*/modalias; do
		modprobe `cat ${m}`
	done

	return 0;
}

load_boot_drivers(){
	echo 'I: Checking installed drivers...'
	depmod
	sleep 1

	echo 'I: Loading drivers...'
	while ! check_redetect_required; do
		detect_and_load_devices;
	done

	return 0;
}

main "${@}";

exit 0;

