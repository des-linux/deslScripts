#!/bin/sh
#//////////////////////////////////////////////////
#//DESLinux DSLoader.d :: System Loader
#//	(C)2014-2022 Dark Embedded Systems.
#//	http://xprj.net/
#//////////////////////////////////////////////////
main(){
#	install_coretools;
	mount_specialfs;
	patch_rootfs;

	return 0;
}

install_coretools(){
	local CT='/bin/busybox';
	local CT0='/mnt/coretools0';

	${CT} mkdir -p /mnt
	${CT} mount -t tmpfs tmpfs://DESL0/mnt /mnt
	[ "${?}" != '0' ] && {
		echo "Failed to mount /mnt" >&3
		exit 1;
	}

	${CT} mkdir -p ${CT0}
	${CT} mount -t tmpfs tmpfs://DESL0/coretools0 ${CT0}
	[ "${?}" != '0' ] && {
		echo "Failed to mount ${CT0}" >&3
		exit 1;
	}

	${CT} mkdir -p ${CT0}/bin
	${CT} mkdir -p ${CT0}/sbin
	${CT} cp ${CT} ${CT0}/${CT}
	${CT} chroot ${CT0} ${CT} --install -s
	[ "${?}" != '0' ] && {
		echo "Failed to install core tools." >&3
		exit 1;
	}

	return 0;
}

patch_rootfs(){
	set -- `cat /proc/version`
	local KVER="${3}";
	[ ! -e "/lib/modules/${KVER}/modules.dep" ] && depmod -a
}

check_mounted(){
	local To=${1};
	local From=${2};
	local Type=${3};

	local IFS=$'\r\n';
	for m in `cat /proc/mounts`; do
		IFS=$' ';
		set - ${m}
		# ${Val:+XXX} = 'XXX' if 'Val' has value.
		[ "${To}@${From}@${Type}" = "${2}@${From:+${1}}@${Type:+${3}}" ] && return 0;
	done

	# No match
	return 1;
}

mount_once(){ # src, target, fs
	local From=${1};
	local To=${2};
	local Type=${3};
	local Opts=${4};

	echo "I: Mounting ${To} ..."

	case "${Type}" in
		"proc")	[ -e "${To}/self" ] && return 0;;
		*)	check_mounted "${To}" "${From}" "${Type}" && return 0;;
	esac

	mkdir -p "${To}"
	mount ${Type:+-t "${Type}"} "${From}" "${To}" ${Opts:+-o ${Opts}} && return 0;

	return 1;
}

rbind_once(){ # src, target
	local From=${1};
	local To=${2};

	echo "I: Binding ${To} ..."
	check_mounted "${To}" && return 0;

	mkdir -p "${To}"
	mount -o rbind "${From}" "${To}" && return 0;

	return 1;
}

mount_specialfs(){
	mount_once proc://DESL0/ /proc proc
	mount_once sysfs://DESL0/ /sys sysfs
	mount_once dev://DESL0/ /DRoot/DarkSystem/dev devtmpfs || mount_once dev://DESL0/ /DRoot/DarkSystem/dev tmpfs size=1m 
	mount_once devpts://DESL0/ /DRoot/DarkSystem/dev/pts devpts
	mount_once tmp://DESL0/ /DRoot/DarkSystem/tmp tmpfs

	rbind_once /DRoot/DarkSystem/dev /dev
	rbind_once /DRoot/DarkSystem/tmp /tmp

	return 0;
}

main "${@}";

exit 0;


