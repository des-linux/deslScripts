#!/bin/sh
PREVCNT=65535;

main(){
	check_dependencies;
	load_drivers;
	register_dev scan
	return 0;
}

check_exec(){
	"${1}" --help
	[ "${?}" = '127' ] && {
		echo "${1} is not found." >&3
		exit 20;
	}
	return 0;
}

check_dependencies(){
	check_exec 'devmm2name'
	return 0;
}

register_dev(){
	[ -e '/dev/null' ] && return 0;
	[ -e '/dev/zero' ] && return 0;

	/DRoot/DarkSystem/bin/devManager ${1} && return 0;
	devManager ${1} && return 0;

	# No devtmpfs support or failed
	check_dependencies;
	devmm2name ${1} && return 0;

	return 127;
}

check_redetect_required(){
	local CNT=0;
	local IFS=$'\r\n';

	for m in `lsmod`; do
		CNT=$((CNT+1));
	done

	[ "${CNT}" = "${PREVCNT}" ] && {
		PREVCNT=${CNT};
		return 0;
	}

	PREVCNT=${CNT};
	return 1;
}

detect_and_load_devices(){
	for m in /sys/bus/*/devices/*/modalias; do
		modprobe `cat ${m}`
	done
}

load_drivers(){
	echo 'I: Loading drivers...'
	depmod -a

	while ! check_redetect_required; do
		detect_and_load_devices 
	done
	return 0;
}

main "${@}";

exit 0;

